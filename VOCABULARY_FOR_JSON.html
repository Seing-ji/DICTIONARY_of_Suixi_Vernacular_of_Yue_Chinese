<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方言词汇音频映射工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #6f42c1, #8e63d2);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .description {
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 25px;
        }
        
        .upload-section {
            flex: 1;
            min-width: 350px;
            padding: 20px;
            border-right: 1px solid #eee;
        }
        
        .preview-section {
            flex: 2;
            min-width: 500px;
            padding: 20px;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #6f42c1;
            border-bottom: 2px solid #6f42c1;
            padding-bottom: 8px;
        }
        
        .upload-area {
            border: 2px dashed #6f42c1;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: #e9ecef;
        }
        
        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .upload-area h3 {
            margin-bottom: 10px;
            color: #6f42c1;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px;
        }
        
        .upload-btn:hover {
            background: #8e63d2;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f9fafc;
        }
        
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-size {
            color: #666;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .file-count {
            color: #6f42c1;
            font-weight: bold;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .json-output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .mapping-info {
            background: #f0e6ff;
            border: 1px solid #d9c6ff;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .process-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .process-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .download-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .reset-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .github-section {
            background: #f9f2f9;
            border: 1px solid #e9d7e9;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .github-section h3 {
            color: #6f42c1;
            margin-bottom: 10px;
        }
        
        .unmatched-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        
        .unmatched-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .unmatched-count {
            background: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .unmatched-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .unmatched-table th {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            text-align: left;
            font-weight: bold;
        }
        
        .unmatched-table td {
            padding: 10px;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .unmatched-table tr:hover {
            background: #fff5f5;
        }
        
        .unmatched-table .index {
            width: 40px;
            text-align: center;
            color: #666;
        }
        
        .unmatched-table .entry {
            font-weight: bold;
            color: #333;
            width: 120px;
        }
        
        .unmatched-table .bvz {
            font-family: monospace;
            color: #6f42c1;
            font-weight: bold;
            width: 150px;
        }
        
        .unmatched-table .note {
            color: #666;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .unmatched-table .status {
            width: 100px;
            text-align: center;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-matched {
            background: #d4edda;
            color: #155724;
        }
        
        .status-unmatched {
            background: #f8d7da;
            color: #721c24;
        }
        
        .unmatched-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .export-unmatched-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .export-unmatched-btn:hover {
            background: #c82333;
        }
        
        .unmatched-pagination {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .pagination-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .pagination-btn:hover {
            background: #5a6268;
        }
        
        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 0.9rem;
            color: #666;
            margin: 0 10px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #ddd;
            background: #f9fafc;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #6f42c1;
            border-bottom-color: #6f42c1;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ddd;
        }
        
        .stat-card h4 {
            color: #6f42c1;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .stat-number.matched {
            color: #28a745;
        }
        
        .stat-number.unmatched {
            color: #dc3545;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .audio-match-info {
            font-size: 0.85rem;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin: 2px 0;
        }
        
        .audio-matched {
            background: #d4edda;
            color: #155724;
        }
        
        .audio-unmatched {
            background: #f8d7da;
            color: #721c24;
        }
        
        .match-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin: 0 2px;
        }
        
        .merge-cell-indicator {
            display: inline-block;
            background: #e3f2fd;
            color: #0d6efd;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .example-count {
            background: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .example-list {
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 5px;
            margin-top: 5px;
            background: #f8f9fa;
        }
        
        .example-item {
            padding: 3px 5px;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }
        
        .example-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .upload-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .unmatched-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .tab-buttons {
                flex-wrap: wrap;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>方言词汇音频映射工具</h1>
            <p class="description">支持部分合并单元格处理，整合例句为上下句关系</p>
        </header>
        
        <div class="main-content">
            <!-- 左侧：上传区域 -->
            <div class="upload-section">
                <h2 class="section-title">上传文件</h2>
                
                <div class="mapping-info">
                    <h3>映射规则说明</h3>
                    <p>1. <strong>部分合并单元格处理</strong>：詞條和BVZ列合并时，例句列不合并</p>
                    <p>2. <strong>例句整合</strong>：合并行中的多个例句自动整合为第一个有效记录的上下句</p>
                    <p>3. <strong>词条音频匹配</strong>：音频文件名与Excel的<strong>BVZ</strong>列精确匹配</p>
                    <p>4. <strong>例句音频匹配</strong>：每个例句BVZ对应一个音频文件</p>
                    <p>5. <strong>精确匹配规则</strong>：除全角/半角符号自动转换外，其他字符严格匹配</p>
                </div>
                
                <div class="upload-area" id="excelUploadArea">
                    <h3>上传Excel文件</h3>
                    <p>拖放Excel文件到这里，或点击选择文件</p>
                    <input type="file" id="excelInput" class="file-input" accept=".xlsx,.xls">
                    <button class="upload-btn" onclick="document.getElementById('excelInput').click()">
                        选择Excel文件
                    </button>
                </div>
                
                <div id="excelFileInfo" class="file-list"></div>
                
                <div class="upload-area" id="audioUploadArea">
                    <h3>上传音频文件</h3>
                    <p>拖放音频文件到这里，或点击选择文件</p>
                    <input type="file" id="audioInput" class="file-input" accept=".mp3,.wav,.ogg" multiple>
                    <button class="upload-btn" onclick="document.getElementById('audioInput').click()">
                        选择音频文件
                    </button>
                </div>
                
                <div id="audioFileInfo" class="file-list"></div>
                
                <div class="github-section">
                    <h3>GitHub仓库配置</h3>
                    <div class="form-group">
                        <label for="githubUsername">GitHub用户名：</label>
                        <input type="text" id="githubUsername" placeholder="例如：Seing-ji" style="width: 100%; padding: 8px; margin: 5px 0;">
                    </div>
                    <div class="form-group">
                        <label for="githubRepo">仓库名称：</label>
                        <input type="text" id="githubRepo" placeholder="例如：DICTIONARY_of_Suixi_Vernacular_of_Yue_Chinese" style="width: 100%; padding: 8px; margin: 5px 0;">
                    </div>
                    <div class="form-group">
                        <label for="audioFolder">音频文件夹路径（可选）：</label>
                        <input type="text" id="audioFolder" placeholder="例如：vocabulary_audio/" style="width: 100%; padding: 8px; margin: 5px 0;">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="process-btn" id="processBtn" onclick="processFiles()" disabled>处理文件并生成JSON</button>
                    <button class="reset-btn" onclick="resetAll()">重置</button>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
            </div>
            
            <!-- 右侧：预览区域 -->
            <div class="preview-section">
                <h2 class="section-title">数据预览</h2>
                
                <div id="mappingStats"></div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" data-tab="preview">数据预览</button>
                        <button class="tab-btn" data-tab="unmatched" id="unmatchedTabBtn">未匹配项</button>
                        <button class="tab-btn" data-tab="json">JSON输出</button>
                    </div>
                    
                    <!-- 数据预览标签页 -->
                    <div id="previewTab" class="tab-content active">
                        <div id="previewSection">
                            <h3>前10条词汇数据预览</h3>
                            <table class="preview-table" id="previewTable">
                                <thead>
                                    <tr>
                                        <th>詞條</th>
                                        <th>词条BVZ</th>
                                        <th>词条音频</th>
                                        <th>例句数</th>
                                        <th>例句音频</th>
                                        <th>匹配状态</th>
                                    </tr>
                                </thead>
                                <tbody id="previewBody">
                                </tbody>
                            </table>
                            
                            <div class="action-buttons">
                                <button class="download-btn" id="downloadBtn" onclick="downloadJSON()" disabled>下载JSON文件</button>
                                <button class="download-btn" id="downloadMappingBtn" onclick="downloadMappingCSV()" disabled>下载映射关系表</button>
                            </div>
                        </div>
                        
                        <div id="instructions" style="display: block;">
                            <div class="mapping-info">
                                <h3>使用说明</h3>
                                <p><strong>部分合并单元格处理：</strong></p>
                                <p>1. 当詞條和BVZ列合并时（如A2:A4、B2:B4合并）</p>
                                <p>2. 例句列不合并（如C2:C4都有独立例句）</p>
                                <p>3. 系统会自动将C2、C3、C4的例句整合到第一条记录</p>
                                <p>4. 生成的结构：一个词条对应多个例句（上下句关系）</p>
                                <p>5. 每个例句BVZ独立匹配对应的音频文件</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 未匹配项标签页 -->
                    <div id="unmatchedTab" class="tab-content">
                        <div class="unmatched-section">
                            <div class="unmatched-header">
                                <h3>未匹配音频的项目列表</h3>
                                <div class="unmatched-count" id="unmatchedCount">0 项</div>
                            </div>
                            
                            <div id="unmatchedList">
                                <p style="text-align: center; color: #666; padding: 40px 0;">
                                    暂无未匹配的项目，或尚未处理数据
                                </p>
                            </div>
                            
                            <div class="unmatched-controls" id="unmatchedControls" style="display: none;">
                                <button class="export-unmatched-btn" id="exportUnmatchedBtn" onclick="exportUnmatchedCSV()">
                                    导出未匹配项CSV
                                </button>
                                <div class="unmatched-pagination" id="unmatchedPagination">
                                    <button class="pagination-btn" id="prevPageBtn" onclick="changeUnmatchedPage(-1)" disabled>上一页</button>
                                    <span class="page-info" id="pageInfo">第 1 页 / 共 1 页</span>
                                    <button class="pagination-btn" id="nextPageBtn" onclick="changeUnmatchedPage(1)" disabled>下一页</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- JSON输出标签页 -->
                    <div id="jsonTab" class="tab-content">
                        <h3>JSON输出</h3>
                        <div class="json-output" id="jsonOutput"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>方言词汇音频映射工具 - 支持部分合并单元格，整合例句为上下句</p>
        </footer>
    </div>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // 全局变量
        let excelData = null;
        let audioFiles = [];
        let processedData = null;
        let mergedCellInfo = null;
        let columnIndices = null; // 存储列索引映射
        
        // 映射统计信息
        let mappingInfo = {
            totalEntries: 0,
            vocabularyMatched: 0,
            vocabularyUnmatched: 0,
            exampleMatched: 0,
            examplePartialMatched: 0,
            exampleUnmatched: 0,
            totalExamples: 0,
            matchedExamples: 0,
            mergedCellsProcessed: 0,
            exampleGroups: 0,
            unmatchedItems: []
        };
        
        let currentUnmatchedPage = 1;
        const UNMATCHED_ITEMS_PER_PAGE = 20;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupFileInputs();
            setupTabSwitching();
            updateProcessButton();
        });
        
        // 设置拖放功能
        function setupDragAndDrop() {
            const excelArea = document.getElementById('excelUploadArea');
            const audioArea = document.getElementById('audioUploadArea');
            
            setupDropZone(excelArea, 'excel');
            setupDropZone(audioArea, 'audio');
        }
        
        function setupDropZone(element, type) {
            element.addEventListener('dragover', function(e) {
                e.preventDefault();
                element.classList.add('dragover');
            });
            
            element.addEventListener('dragleave', function() {
                element.classList.remove('dragover');
            });
            
            element.addEventListener('drop', function(e) {
                e.preventDefault();
                element.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (type === 'excel') {
                        handleExcelFile(files[0]);
                    } else if (type === 'audio') {
                        handleAudioFiles(files);
                    }
                }
            });
        }
        
        // 设置文件输入
        function setupFileInputs() {
            const excelInput = document.getElementById('excelInput');
            const audioInput = document.getElementById('audioInput');
            
            excelInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleExcelFile(e.target.files[0]);
                }
            });
            
            audioInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleAudioFiles(e.target.files);
                }
            });
        }
        
        // 设置标签页切换
        function setupTabSwitching() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
        }
        
        // 处理Excel文件
        function handleExcelFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus('请选择Excel文件 (.xlsx 或 .xls)', 'error');
                return;
            }
            
            displayFileInfo('excelFileInfo', file);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 获取合并单元格信息和列索引
                    mergedCellInfo = worksheet['!merges'] || [];
                    columnIndices = getColumnIndices(worksheet);
                    
                    // 转换为JSON（保留空字符串）
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                    
                    if (jsonData.length === 0) {
                        showStatus('Excel文件中没有数据', 'error');
                        return;
                    }
                    
                    // 处理部分合并单元格的数据
                    excelData = processPartiallyMergedCells(jsonData, worksheet);
                    
                    showStatus(`成功加载Excel数据，共 ${excelData.length} 条词汇记录，处理 ${mappingInfo.mergedCellsProcessed} 处部分合并`, 'success');
                    
                    if (audioFiles.length > 0) {
                        updateMappingStats();
                    }
                    
                    updateProcessButton();
                    
                } catch (error) {
                    showStatus('Excel文件读取失败: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('文件读取失败', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 获取列索引映射
        function getColumnIndices(worksheet) {
            const columnIndices = {};
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            
            // 获取标题行（第一行）
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                const cell = worksheet[cellAddress];
                if (cell && cell.v) {
                    // 存储列名和索引的映射
                    const columnName = String(cell.v).trim();
                    columnIndices[columnName] = col;
                    
                    // 也存储常见列名的变体
                    if (columnName === '詞條') {
                        columnIndices['词条'] = col;
                    } else if (columnName === '词条') {
                        columnIndices['詞條'] = col;
                    } else if (columnName === '例句的BVZ轉寫') {
                        columnIndices['例句BVZ转写'] = col;
                    } else if (columnName === '例句BVZ转写') {
                        columnIndices['例句的BVZ轉寫'] = col;
                    }
                }
            }
            
            return columnIndices;
        }
        
        // 处理部分合并单元格的情况
        function processPartiallyMergedCells(jsonData, worksheet) {
            const processedData = [];
            let currentGroup = null;
            let mergeCount = 0;
            
            // 重置统计
            mappingInfo.mergedCellsProcessed = 0;
            mappingInfo.exampleGroups = 0;
            
            for (let i = 0; i < jsonData.length; i++) {
                const item = jsonData[i];
                const rowIndex = i + 2; // +2 因为Excel行号从1开始，且第1行是标题
                
                // 检查当前行是否属于合并单元格的一部分
                const mergeInfo = getMergeInfoForRow(rowIndex);
                
                if (mergeInfo && mergeInfo.isStartOfMerge) {
                    // 这是合并单元格的开始行
                    mergeCount++;
                    
                    // 如果有正在处理的组，先保存
                    if (currentGroup) {
                        processedData.push(currentGroup);
                        mappingInfo.exampleGroups++;
                    }
                    
                    // 创建新的组
                    currentGroup = createDataGroup(item, rowIndex, mergeInfo);
                    
                } else if (mergeInfo && mergeInfo.isInMerge && currentGroup) {
                    // 这是合并单元格的后续行，将例句添加到当前组
                    addExampleToGroup(currentGroup, item, rowIndex);
                    mappingInfo.mergedCellsProcessed++;
                    
                } else if (!mergeInfo) {
                    // 这不是合并单元格
                    // 如果有正在处理的组，先保存
                    if (currentGroup) {
                        processedData.push(currentGroup);
                        mappingInfo.exampleGroups++;
                        currentGroup = null;
                    }
                    
                    // 创建独立记录
                    const singleItem = createSingleDataItem(item, rowIndex);
                    processedData.push(singleItem);
                }
            }
            
            // 处理最后一个组
            if (currentGroup) {
                processedData.push(currentGroup);
                mappingInfo.exampleGroups++;
            }
            
            return processedData;
        }
        
        // 获取行的合并信息
        function getMergeInfoForRow(rowIndex) {
            if (!mergedCellInfo || mergedCellInfo.length === 0) return null;
            
            // 检查关键列是否被合并
            const criticalColumns = ['詞條', '词条', 'BVZ'];
            let isInMerge = false;
            let isStartOfMerge = false;
            let mergeRange = null;
            
            for (const colName of criticalColumns) {
                const colIndex = columnIndices[colName];
                if (colIndex !== undefined) {
                    for (const merge of mergedCellInfo) {
                        const startRow = merge.s.r + 1; // 转换为1-based
                        const endRow = merge.e.r + 1;
                        const startCol = merge.s.c;
                        const endCol = merge.e.c;
                        
                        if (rowIndex >= startRow && rowIndex <= endRow && 
                            colIndex >= startCol && colIndex <= endCol) {
                            isInMerge = true;
                            isStartOfMerge = (rowIndex === startRow);
                            mergeRange = { startRow, endRow, startCol, endCol };
                            break;
                        }
                    }
                    if (isInMerge) break;
                }
            }
            
            if (!isInMerge) return null;
            
            return {
                isInMerge: true,
                isStartOfMerge: isStartOfMerge,
                mergeRange: mergeRange
            };
        }
        
        // 创建数据组（用于部分合并的情况）
        function createDataGroup(item, rowIndex, mergeInfo) {
            const processedItem = {
                詞條: '',
                BVZ: '',
                詞條類別: '',
                釋義: '',
                例句: [], // 改为数组，存储多个例句
                例句的BVZ轉寫: [], // 改为数组，存储多个例句BVZ
                vocabularyAudio: null,
                exampleAudios: [], // 改为数组，存储多个例句音频
                vocabularyMatched: false,
                exampleMatched: false,
                examplePartialMatched: false,
                vocabularyBvzNormalized: '',
                exampleBvzNormalized: [],
                isMergedGroup: true,
                mergeRange: mergeInfo.mergeRange,
                exampleCount: 0,
                exampleMatchedCount: 0
            };
            
            // 处理基本字段
            processBasicFields(processedItem, item);
            
            // 添加第一个例句
            addExampleToGroup(processedItem, item, rowIndex);
            
            // 标准化词条BVZ
            if (processedItem.BVZ) {
                processedItem.vocabularyBvzNormalized = normalizeFullWidthChars(processedItem.BVZ);
            }
            
            return processedItem;
        }
        
        // 添加例句到组
        function addExampleToGroup(group, item, rowIndex) {
            const example = extractField(item, '例句');
            const exampleBvz = extractField(item, '例句的BVZ轉寫');
            
            if (example || exampleBvz) {
                group.例句.push(example || '');
                group.例句的BVZ轉寫.push(exampleBvz || '');
                group.exampleCount++;
                
                // 标准化例句BVZ
                if (exampleBvz) {
                    group.exampleBvzNormalized.push(normalizeFullWidthChars(exampleBvz));
                } else {
                    group.exampleBvzNormalized.push('');
                }
            }
        }
        
        // 创建独立数据项
        function createSingleDataItem(item, rowIndex) {
            const processedItem = {
                詞條: '',
                BVZ: '',
                詞條類別: '',
                釋義: '',
                例句: [], // 统一使用数组格式
                例句的BVZ轉寫: [],
                vocabularyAudio: null,
                exampleAudios: [],
                vocabularyMatched: false,
                exampleMatched: false,
                examplePartialMatched: false,
                vocabularyBvzNormalized: '',
                exampleBvzNormalized: [],
                isMergedGroup: false,
                exampleCount: 0,
                exampleMatchedCount: 0
            };
            
            // 处理基本字段
            processBasicFields(processedItem, item);
            
            // 添加例句（即使是独立记录也使用数组格式）
            const example = extractField(item, '例句');
            const exampleBvz = extractField(item, '例句的BVZ轉寫');
            
            if (example || exampleBvz) {
                processedItem.例句.push(example || '');
                processedItem.例句的BVZ轉寫.push(exampleBvz || '');
                processedItem.exampleCount = 1;
                
                // 标准化例句BVZ
                if (exampleBvz) {
                    processedItem.exampleBvzNormalized.push(normalizeFullWidthChars(exampleBvz));
                } else {
                    processedItem.exampleBvzNormalized.push('');
                }
            }
            
            // 标准化词条BVZ
            if (processedItem.BVZ) {
                processedItem.vocabularyBvzNormalized = normalizeFullWidthChars(processedItem.BVZ);
            }
            
            return processedItem;
        }
        
        // 处理基本字段
        function processBasicFields(processedItem, item) {
            const fields = ['詞條', 'BVZ', '詞條類別', '釋義'];
            
            fields.forEach(field => {
                const value = extractField(item, field);
                processedItem[field] = value || '';
            });
        }
        
        // 提取字段值（支持多种列名）
        function extractField(item, fieldName) {
            // 字段名映射
            const fieldMap = {
                '詞條': ['詞條', '词条', '词语', '词汇'],
                'BVZ': ['BVZ', 'bvz', 'Bvz', '词条BVZ', '词条发音'],
                '詞條類別': ['詞條類別', '词条类别', '类别', '分类'],
                '釋義': ['釋義', '释义', '解释', '意思'],
                '例句': ['例句', '例子', '示例'],
                '例句的BVZ轉寫': ['例句的BVZ轉寫', '例句BVZ转写', '例句发音', '例句BVZ']
            };
            
            const possibleNames = fieldMap[fieldName] || [fieldName];
            
            for (const name of possibleNames) {
                if (item[name] !== undefined && item[name] !== null && item[name] !== '') {
                    return String(item[name]).trim();
                }
            }
            
            return '';
        }
        
        // 处理音频文件
        function handleAudioFiles(files) {
            const audioFileList = Array.from(files).filter(file => 
                file.name.match(/\.(mp3|wav|ogg)$/i)
            );
            
            if (audioFileList.length === 0) {
                showStatus('请选择音频文件 (.mp3, .wav, .ogg)', 'error');
                return;
            }
            
            audioFileList.forEach(file => {
                if (!audioFiles.some(f => f.name === file.name)) {
                    audioFiles.push(file);
                }
            });
            
            displayAudioFileInfo();
            
            showStatus(`成功加载 ${audioFileList.length} 个音频文件`, 'success');
            
            if (excelData) {
                updateMappingStats();
            }
            
            updateProcessButton();
        }
        
        // 仅转换全角字符为半角，保留其他所有字符（包括空格、标点等）
        function normalizeFullWidthChars(text) {
            if (!text) return '';
            
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                
                // 全角字母、数字、空格转半角
                if (charCode >= 0xFF01 && charCode <= 0xFF5E) {
                    // 全角字符转半角（0xFF01-0xFF5E -> 0x21-0x7E）
                    result += String.fromCharCode(charCode - 0xFEE0);
                } else if (charCode === 0x3000) { // 全角空格转半角空格
                    result += String.fromCharCode(0x0020);
                } else if (charCode >= 0xFF10 && charCode <= 0xFF19) { // 全角数字
                    result += String.fromCharCode(charCode - 0xFEE0);
                } else if (charCode >= 0xFF21 && charCode <= 0xFF3A) { // 全角大写字母
                    result += String.fromCharCode(charCode - 0xFEE0);
                } else if (charCode >= 0xFF41 && charCode <= 0xFF5A) { // 全角小写字母
                    result += String.fromCharCode(charCode - 0xFEE0);
                } else {
                    // 其他字符（包括半角字符、中文、标点等）原样保留
                    result += text.charAt(i);
                }
            }
            
            return result;
        }
        
        // 获取文件名（不含扩展名）
        function getFileNameWithoutExtension(filename) {
            if (!filename) return '';
            const lastDotIndex = filename.lastIndexOf('.');
            return lastDotIndex === -1 ? filename : filename.substring(0, lastDotIndex);
        }
        
        // 标准化音频文件名（仅全角转半角）
        function normalizeAudioFileName(filename) {
            const nameWithoutExt = getFileNameWithoutExtension(filename);
            return normalizeFullWidthChars(nameWithoutExt);
        }
        
        // 显示文件信息
        function displayFileInfo(containerId, file) {
            const container = document.getElementById(containerId);
            const fileSize = formatFileSize(file.size);
            
            container.innerHTML = `
                <div class="file-item">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
            `;
        }
        
        // 显示音频文件信息
        function displayAudioFileInfo() {
            const container = document.getElementById('audioFileInfo');
            
            if (audioFiles.length === 0) {
                container.innerHTML = '<p>未选择音频文件</p>';
                return;
            }
            
            let html = `<p class="file-count">已选择 ${audioFiles.length} 个音频文件</p>`;
            
            const displayFiles = audioFiles.slice(0, 5);
            
            displayFiles.forEach(file => {
                const fileSize = formatFileSize(file.size);
                html += `
                    <div class="file-item">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                `;
            });
            
            if (audioFiles.length > 5) {
                html += `<p>... 以及其他 ${audioFiles.length - 5} 个文件</p>`;
            }
            
            container.innerHTML = html;
        }
        
        // 更新映射统计
        function updateMappingStats() {
            if (!excelData) return;
            
            // 重置统计
            mappingInfo.totalEntries = excelData.length;
            mappingInfo.vocabularyMatched = 0;
            mappingInfo.vocabularyUnmatched = 0;
            mappingInfo.exampleMatched = 0;
            mappingInfo.examplePartialMatched = 0;
            mappingInfo.exampleUnmatched = 0;
            mappingInfo.totalExamples = 0;
            mappingInfo.matchedExamples = 0;
            mappingInfo.unmatchedItems = [];
            
            // 创建音频文件映射（标准化文件名 -> 文件对象）
            const audioFileMap = {};
            audioFiles.forEach(file => {
                const normalizedName = normalizeAudioFileName(file.name);
                audioFileMap[normalizedName] = file;
            });
            
            // 统计匹配情况
            excelData.forEach((item, index) => {
                const vocabBVZ = item.vocabularyBvzNormalized;
                
                // 1. 统计词条音频匹配
                if (vocabBVZ && audioFileMap[vocabBVZ]) {
                    mappingInfo.vocabularyMatched++;
                } else if (vocabBVZ) {
                    mappingInfo.vocabularyUnmatched++;
                    mappingInfo.unmatchedItems.push({
                        type: 'vocabulary',
                        index: index + 1,
                        詞條: item.詞條,
                        BVZ: item.BVZ,
                        詞條類別: item.詞條類別,
                        expectedAudio: vocabBVZ,
                        originalBvz: item.BVZ,
                        isMergedGroup: item.isMergedGroup,
                        exampleCount: item.exampleCount
                    });
                }
                
                // 2. 统计例句音频匹配
                item.exampleMatchedCount = 0;
                mappingInfo.totalExamples += item.exampleCount;
                
                if (item.exampleCount > 0) {
                    for (let i = 0; i < item.exampleCount; i++) {
                        const exampleBvz = item.exampleBvzNormalized[i];
                        
                        if (exampleBvz && audioFileMap[exampleBvz]) {
                            item.exampleMatchedCount++;
                            mappingInfo.matchedExamples++;
                        } else if (exampleBvz) {
                            mappingInfo.unmatchedItems.push({
                                type: 'example',
                                index: index + 1,
                                詞條: item.詞條,
                                BVZ: item.BVZ,
                                詞條類別: item.詞條類別,
                                例句: item.例句[i],
                                exampleBVZ: item.例句的BVZ轉寫[i],
                                exampleIndex: i + 1,
                                expectedAudio: exampleBvz,
                                originalBvz: item.例句的BVZ轉寫[i],
                                isMergedGroup: item.isMergedGroup,
                                totalExamplesInGroup: item.exampleCount
                            });
                        }
                    }
                    
                    // 更新例句匹配状态
                    if (item.exampleMatchedCount === item.exampleCount && item.exampleCount > 0) {
                        item.exampleMatched = true;
                        mappingInfo.exampleMatched++;
                    } else if (item.exampleMatchedCount > 0 && item.exampleMatchedCount < item.exampleCount) {
                        item.examplePartialMatched = true;
                        mappingInfo.examplePartialMatched++;
                    } else if (item.exampleCount > 0 && item.exampleMatchedCount === 0) {
                        item.exampleMatched = false;
                        mappingInfo.exampleUnmatched++;
                    }
                }
            });
            
            displayMappingStats();
        }
        
        // 显示映射统计
        function displayMappingStats() {
            const container = document.getElementById('mappingStats');
            
            const vocabRate = mappingInfo.totalEntries > 0 ? 
                ((mappingInfo.vocabularyMatched / mappingInfo.totalEntries) * 100).toFixed(1) : 0;
            
            const exampleRate = mappingInfo.totalExamples > 0 ? 
                ((mappingInfo.matchedExamples / mappingInfo.totalExamples) * 100).toFixed(1) : 0;
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>词汇总数</h4>
                        <div class="stat-number">${mappingInfo.totalEntries}</div>
                        <div class="stat-label">条词汇记录</div>
                    </div>
                    <div class="stat-card">
                        <h4>词条音频匹配</h4>
                        <div class="stat-number ${mappingInfo.vocabularyMatched > 0 ? 'matched' : ''}">
                            ${mappingInfo.vocabularyMatched}
                        </div>
                        <div class="stat-label">已匹配 ${vocabRate}%</div>
                    </div>
                    <div class="stat-card">
                        <h4>例句总数</h4>
                        <div class="stat-number">${mappingInfo.totalExamples}</div>
                        <div class="stat-label">个例句</div>
                    </div>
                    <div class="stat-card">
                        <h4>例句音频匹配</h4>
                        <div class="stat-number ${mappingInfo.matchedExamples > 0 ? 'matched' : ''}">
                            ${mappingInfo.matchedExamples}
                        </div>
                        <div class="stat-label">已匹配 ${exampleRate}%</div>
                    </div>
                    <div class="stat-card">
                        <h4>合并单元格组</h4>
                        <div class="stat-number">${mappingInfo.exampleGroups}</div>
                        <div class="stat-label">组部分合并</div>
                    </div>
                    <div class="stat-card">
                        <h4>未匹配总项</h4>
                        <div class="stat-number ${mappingInfo.unmatchedItems.length > 0 ? 'unmatched' : ''}">
                            ${mappingInfo.unmatchedItems.length}
                        </div>
                        <div class="stat-label">需检查</div>
                    </div>
                </div>
            `;
            
            // 更新未匹配标签按钮的计数
            const unmatchedTabBtn = document.getElementById('unmatchedTabBtn');
            const totalUnmatched = mappingInfo.unmatchedItems.length;
            if (totalUnmatched > 0) {
                unmatchedTabBtn.innerHTML = `未匹配项 <span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px;">${totalUnmatched}</span>`;
            } else {
                unmatchedTabBtn.textContent = '未匹配项';
            }
        }
        
        // 更新处理按钮状态
        function updateProcessButton() {
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = !(excelData && excelData.length > 0);
        }
        
        // 处理文件并生成JSON
        function processFiles() {
            if (!excelData || excelData.length === 0) {
                showStatus('请先上传Excel文件', 'error');
                return;
            }
            
            const githubUsername = document.getElementById('githubUsername').value.trim();
            const githubRepo = document.getElementById('githubRepo').value.trim();
            const audioFolder = document.getElementById('audioFolder').value.trim();
            
            if (!githubUsername || !githubRepo) {
                showStatus('请填写GitHub用户名和仓库名称', 'error');
                return;
            }
            
            // 创建音频文件映射（标准化文件名 -> 文件信息）
            const audioFileMap = {};
            audioFiles.forEach(file => {
                const normalizedName = normalizeAudioFileName(file.name);
                audioFileMap[normalizedName] = {
                    file: file,
                    name: file.name,
                    extension: file.name.substring(file.name.lastIndexOf('.') + 1),
                    normalizedName: normalizedName
                };
            });
            
            // 重置映射信息
            mappingInfo.unmatchedItems = [];
            
            // 处理数据
            processedData = excelData.map((item, index) => {
                const processedItem = { ...item };
                const vocabBVZ = item.vocabularyBvzNormalized;
                
                // 1. 处理词条音频（BVZ列）
                if (vocabBVZ && audioFileMap[vocabBVZ]) {
                    const audioInfo = audioFileMap[vocabBVZ];
                    const folderPath = audioFolder ? `${audioFolder}/` : '';
                    const audioURL = `https://raw.githubusercontent.com/${githubUsername}/${githubRepo}/main/${folderPath}${audioInfo.name}`;
                    
                    processedItem.vocabularyAudio = {
                        filename: audioInfo.name,
                        url: audioURL,
                        originalBvz: item.BVZ,
                        normalizedBvz: vocabBVZ
                    };
                    processedItem.vocabularyMatched = true;
                } else {
                    processedItem.vocabularyAudio = null;
                    processedItem.vocabularyMatched = false;
                    
                    if (vocabBVZ) {
                        mappingInfo.unmatchedItems.push({
                            type: 'vocabulary',
                            index: index + 1,
                            詞條: item.詞條,
                            BVZ: item.BVZ,
                            詞條類別: item.詞條類別,
                            expectedAudio: vocabBVZ,
                            originalBvz: item.BVZ,
                            isMergedGroup: item.isMergedGroup,
                            exampleCount: item.exampleCount
                        });
                    }
                }
                
                // 2. 处理例句音频
                processedItem.exampleAudios = [];
                processedItem.exampleMatchedCount = 0;
                
                if (item.exampleCount > 0) {
                    for (let i = 0; i < item.exampleCount; i++) {
                        const exampleBvz = item.exampleBvzNormalized[i];
                        
                        if (exampleBvz && audioFileMap[exampleBvz]) {
                            const audioInfo = audioFileMap[exampleBvz];
                            const folderPath = audioFolder ? `${audioFolder}/` : '';
                            const audioURL = `https://raw.githubusercontent.com/${githubUsername}/${githubRepo}/main/${folderPath}${audioInfo.name}`;
                            
                            processedItem.exampleAudios.push({
                                filename: audioInfo.name,
                                url: audioURL,
                                originalBvz: item.例句的BVZ轉寫[i],
                                normalizedBvz: exampleBvz,
                                exampleIndex: i + 1
                            });
                            processedItem.exampleMatchedCount++;
                        } else if (exampleBvz) {
                            mappingInfo.unmatchedItems.push({
                                type: 'example',
                                index: index + 1,
                                詞條: item.詞條,
                                BVZ: item.BVZ,
                                詞條類別: item.詞條類別,
                                例句: item.例句[i],
                                exampleBVZ: item.例句的BVZ轉寫[i],
                                exampleIndex: i + 1,
                                expectedAudio: exampleBvz,
                                originalBvz: item.例句的BVZ轉寫[i],
                                isMergedGroup: item.isMergedGroup,
                                totalExamplesInGroup: item.exampleCount
                            });
                        } else {
                            processedItem.exampleAudios.push(null);
                        }
                    }
                    
                    // 更新例句匹配状态
                    if (processedItem.exampleMatchedCount === processedItem.exampleCount && processedItem.exampleCount > 0) {
                        processedItem.exampleMatched = true;
                        processedItem.examplePartialMatched = false;
                    } else if (processedItem.exampleMatchedCount > 0 && processedItem.exampleMatchedCount < processedItem.exampleCount) {
                        processedItem.exampleMatched = false;
                        processedItem.examplePartialMatched = true;
                    } else {
                        processedItem.exampleMatched = false;
                        processedItem.examplePartialMatched = false;
                    }
                }
                
                return processedItem;
            });
            
            // 更新统计
            mappingInfo.vocabularyUnmatched = mappingInfo.unmatchedItems.filter(item => item.type === 'vocabulary').length;
            mappingInfo.exampleUnmatched = mappingInfo.unmatchedItems.filter(item => item.type === 'example').length;
            
            // 显示未匹配项
            displayUnmatchedItems();
            
            // 显示预览
            showPreview(processedData);
            showJSON(processedData);
            
            // 启用下载按钮
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('downloadMappingBtn').disabled = false;
            
            // 显示数据预览标签页
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('instructions').style.display = 'none';
            
            // 更新映射统计显示
            displayMappingStats();
            
            showStatus(`处理完成！词汇：${mappingInfo.totalEntries}条，例句：${mappingInfo.totalExamples}个，词条音频匹配：${mappingInfo.vocabularyMatched}，例句音频匹配：${mappingInfo.matchedExamples}`, 'success');
        }
        
        // 显示未匹配项
        function displayUnmatchedItems() {
            const container = document.getElementById('unmatchedList');
            const unmatchedCountElement = document.getElementById('unmatchedCount');
            
            unmatchedCountElement.textContent = `${mappingInfo.unmatchedItems.length} 项`;
            
            if (mappingInfo.unmatchedItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px 0;">所有音频都已成功匹配！</p>';
                document.getElementById('unmatchedControls').style.display = 'none';
                return;
            }
            
            // 计算分页
            const totalPages = Math.ceil(mappingInfo.unmatchedItems.length / UNMATCHED_ITEMS_PER_PAGE);
            
            if (currentUnmatchedPage > totalPages) currentUnmatchedPage = totalPages;
            if (currentUnmatchedPage < 1) currentUnmatchedPage = 1;
            
            const startIndex = (currentUnmatchedPage - 1) * UNMATCHED_ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + UNMATCHED_ITEMS_PER_PAGE, mappingInfo.unmatchedItems.length);
            const pageItems = mappingInfo.unmatchedItems.slice(startIndex, endIndex);
            
            // 创建表格
            let html = `
                <table class="unmatched-table">
                    <thead>
                        <tr>
                            <th class="index">#</th>
                            <th class="entry">詞條</th>
                            <th class="bvz">类型</th>
                            <th>原始BVZ</th>
                            <th>期望匹配的音频名</th>
                            <th class="status">状态</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pageItems.forEach((item, index) => {
                const globalIndex = startIndex + index + 1;
                const typeText = item.type === 'vocabulary' ? '词条音频' : `例句${item.exampleIndex ? '#' + item.exampleIndex : ''}`;
                const typeColor = item.type === 'vocabulary' ? '#6f42c1' : '#17a2b8';
                const bvzText = item.type === 'vocabulary' ? item.BVZ : item.exampleBVZ;
                const mergeIndicator = item.isMergedGroup ? 
                    '<span class="merge-cell-indicator" title="合并单元格组">合并组</span>' : '';
                
                html += `
                    <tr>
                        <td class="index">${globalIndex}</td>
                        <td class="entry">${escapeHtml(item.詞條)}${mergeIndicator}<br>
                            <small style="color:#666">${escapeHtml(item.詞條類別)}</small>
                        </td>
                        <td class="bvz" style="color:${typeColor}">
                            <strong>${typeText}</strong>
                        </td>
                        <td style="font-family:monospace; font-size:0.9rem; max-width:200px; word-break:break-all;">
                            ${escapeHtml(bvzText)}
                        </td>
                        <td style="font-family:monospace; font-weight:bold;">
                            ${escapeHtml(item.expectedAudio)}.mp3
                        </td>
                        <td class="status">
                            <span class="status-badge status-unmatched">未匹配</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            
            container.innerHTML = html;
            
            // 更新分页控件
            updatePaginationControls(totalPages);
            
            // 显示控制按钮
            document.getElementById('unmatchedControls').style.display = 'flex';
        }
        
        // 更新分页控件
        function updatePaginationControls(totalPages) {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            prevBtn.disabled = currentUnmatchedPage <= 1;
            nextBtn.disabled = currentUnmatchedPage >= totalPages;
            
            pageInfo.textContent = `第 ${currentUnmatchedPage} 页 / 共 ${totalPages} 页`;
        }
        
        // 切换未匹配项页面
        function changeUnmatchedPage(direction) {
            const totalPages = Math.ceil(mappingInfo.unmatchedItems.length / UNMATCHED_ITEMS_PER_PAGE);
            const newPage = currentUnmatchedPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentUnmatchedPage = newPage;
                displayUnmatchedItems();
            }
        }
        
        // 导出未匹配项CSV
        function exportUnmatchedCSV() {
            if (mappingInfo.unmatchedItems.length === 0) {
                showStatus('没有未匹配的项目可导出', 'error');
                return;
            }
            
            let csvContent = "序号,詞條,BVZ,詞條類別,音频类型,原始BVZ,期望匹配的音频名,例句,是否合并组,例句序号\n";
            
            mappingInfo.unmatchedItems.forEach((item, index) => {
                const typeText = item.type === 'vocabulary' ? '词条音频' : '例句音频';
                const bvzText = item.type === 'vocabulary' ? item.BVZ : item.exampleBVZ;
                const exampleText = item.type === 'example' ? (item.例句 || '') : '';
                const mergeText = item.isMergedGroup ? '是' : '否';
                const exampleIndex = item.type === 'example' ? item.exampleIndex : '';
                
                const row = [
                    index + 1,
                    `"${item.詞條}"`,
                    `"${item.BVZ}"`,
                    `"${item.詞條類別}"`,
                    `"${typeText}"`,
                    `"${bvzText}"`,
                    `"${item.expectedAudio}"`,
                    `"${exampleText}"`,
                    `"${mergeText}"`,
                    `"${exampleIndex}"`
                ].join(',');
                
                csvContent += row + "\n";
            });
            
            const blob = new Blob(['\ufeff' + csvContent], {
                type: 'text/csv;charset=utf-8'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `未匹配音频项_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`已导出 ${mappingInfo.unmatchedItems.length} 条未匹配项`, 'success');
        }
        
        // 显示预览
        function showPreview(data) {
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            
            const displayData = data.slice(0, 10);
            
            displayData.forEach(item => {
                const row = document.createElement('tr');
                
                // 词条音频状态
                let vocabStatus = '';
                if (item.vocabularyMatched) {
                    vocabStatus = `<span class="audio-match-info audio-matched">
                        ✓ 已匹配: ${item.vocabularyAudio.filename}
                    </span>`;
                } else if (item.BVZ) {
                    vocabStatus = `<span class="audio-match-info audio-unmatched">
                        ✗ 未匹配: ${escapeHtml(item.BVZ)}
                    </span>`;
                } else {
                    vocabStatus = `<span style="color:#666">无词条BVZ</span>`;
                }
                
                // 例句数量和状态
                let exampleStatus = '';
                let exampleDetails = '';
                
                if (item.exampleCount === 0) {
                    exampleStatus = `<span style="color:#666">无例句</span>`;
                } else {
                    const matchedText = item.exampleMatched ? '完全匹配' : 
                                      item.examplePartialMatched ? '部分匹配' : '未匹配';
                    const statusColor = item.exampleMatched ? '#28a745' : 
                                       item.examplePartialMatched ? '#ffc107' : '#dc3545';
                    
                    exampleStatus = `<span class="example-count">${item.exampleCount}例</span>
                                    <span style="color:${statusColor}">${matchedText} (${item.exampleMatchedCount}/${item.exampleCount})</span>`;
                    
                    // 例句详情
                    exampleDetails = `<div class="example-list">`;
                    for (let i = 0; i < Math.min(item.exampleCount, 3); i++) {
                        const example = item.例句[i] || '';
                        const bvz = item.例句的BVZ轉寫[i] || '';
                        const hasAudio = item.exampleAudios[i];
                        const statusIcon = hasAudio ? '✓' : '✗';
                        const statusColor = hasAudio ? '#28a745' : '#dc3545';
                        
                        exampleDetails += `<div class="example-item">
                            <span style="color:${statusColor}">${statusIcon}</span> 
                            ${escapeHtml(example.substring(0, 30))}${example.length > 30 ? '...' : ''}
                        </div>`;
                    }
                    if (item.exampleCount > 3) {
                        exampleDetails += `<div class="example-item" style="color:#666; text-align:center;">
                            ... 还有 ${item.exampleCount - 3} 条例句
                        </div>`;
                    }
                    exampleDetails += `</div>`;
                }
                
                // 匹配状态指示器
                let matchIndicator = '';
                if (item.vocabularyMatched) {
                    matchIndicator += '<span class="match-indicator" style="background:#d4edda;color:#155724;">词条✓</span>';
                } else if (item.BVZ) {
                    matchIndicator += '<span class="match-indicator" style="background:#f8d7da;color:#721c24;">词条✗</span>';
                }
                
                if (item.exampleMatched) {
                    matchIndicator += '<span class="match-indicator" style="background:#d4edda;color:#155724;">例句✓</span>';
                } else if (item.examplePartialMatched) {
                    matchIndicator += '<span class="match-indicator" style="background:#fff3cd;color:#856404;">例句⚠</span>';
                } else if (item.exampleCount > 0) {
                    matchIndicator += '<span class="match-indicator" style="background:#f8d7da;color:#721c24;">例句✗</span>';
                }
                
                // 合并单元格指示器
                const mergeIndicator = item.isMergedGroup ? 
                    '<span class="merge-cell-indicator" title="合并单元格组">合并组</span>' : '';
                
                row.innerHTML = `
                    <td>${escapeHtml(item.詞條)}${mergeIndicator}<br><small style="color:#666">${escapeHtml(item.詞條類別)}</small></td>
                    <td style="font-family:monospace;">${escapeHtml(item.BVZ || '')}</td>
                    <td>${vocabStatus}</td>
                    <td>${exampleStatus}${exampleDetails}</td>
                    <td>${exampleStatus.replace('例', '个音频')}</td>
                    <td>${matchIndicator}</td>
                `;
                previewBody.appendChild(row);
            });
        }
        
        // 显示JSON - 整合后的结构
        function showJSON(data) {
            const jsonOutput = document.getElementById('jsonOutput');
            
            const jsonData = data.map(item => {
                // 创建整合后的JSON结构
                const jsonItem = {
                    詞條: item.詞條,
                    BVZ: item.BVZ,
                    詞條類別: item.詞條類別,
                    釋義: item.釋義,
                    // 词条音频 - 单独字段
                    vocabularyAudio: item.vocabularyAudio ? item.vocabularyAudio.url : null,
                    // 例句 - 数组格式，每个例句包含文本和音频
                    examples: []
                };
                
                // 添加例句数组
                for (let i = 0; i < item.exampleCount; i++) {
                    const example = {
                        例句: item.例句[i] || '',
                        例句的BVZ轉寫: item.例句的BVZ轉寫[i] || '',
                        // 例句音频 - 单独字段
                        exampleAudio: item.exampleAudios[i] ? item.exampleAudios[i].url : null
                    };
                    jsonItem.examples.push(example);
                }
                
                return jsonItem;
            });
            
            jsonOutput.textContent = JSON.stringify(jsonData, null, 2);
        }
        
        // 下载JSON文件
        function downloadJSON() {
            if (!processedData) return;
            
            const jsonData = processedData.map(item => {
                const jsonItem = {
                    詞條: item.詞條,
                    BVZ: item.BVZ,
                    詞條類別: item.詞條類別,
                    釋義: item.釋義,
                    vocabularyAudio: item.vocabularyAudio ? item.vocabularyAudio.url : null,
                    examples: []
                };
                
                for (let i = 0; i < item.exampleCount; i++) {
                    const example = {
                        例句: item.例句[i] || '',
                        例句的BVZ轉寫: item.例句的BVZ轉寫[i] || '',
                        exampleAudio: item.exampleAudios[i] ? item.exampleAudios[i].url : null
                    };
                    jsonItem.examples.push(example);
                }
                
                return jsonItem;
            });
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vocabulary_with_audio.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('JSON文件下载成功！', 'success');
        }
        
        // 下载映射关系CSV
        function downloadMappingCSV() {
            if (!processedData) return;
            
            let csvContent = "序号,詞條,BVZ,詞條類別,釋義,是否合并组,例句数量,词条音频文件,词条音频URL,词条匹配状态,例句序号,例句文本,例句BVZ,例句音频文件,例句音频URL,例句匹配状态\n";
            
            processedData.forEach((item, index) => {
                const vocabStatus = item.vocabularyMatched ? "已匹配" : "未匹配";
                const vocabFile = item.vocabularyAudio ? item.vocabularyAudio.filename : "";
                const vocabURL = item.vocabularyAudio ? item.vocabularyAudio.url : "";
                const mergeStatus = item.isMergedGroup ? "是" : "否";
                
                // 如果没有例句，输出一行
                if (item.exampleCount === 0) {
                    const row = [
                        index + 1,
                        `"${item.詞條}"`,
                        `"${item.BVZ}"`,
                        `"${item.詞條類別}"`,
                        `"${item.釋義}"`,
                        `"${mergeStatus}"`,
                        "0",
                        `"${vocabFile}"`,
                        `"${vocabURL}"`,
                        `"${vocabStatus}"`,
                        "",
                        "",
                        "",
                        "",
                        "",
                        ""
                    ].join(',');
                    csvContent += row + "\n";
                } else {
                    // 为每个例句输出一行
                    for (let i = 0; i < item.exampleCount; i++) {
                        const example = item.例句[i] || '';
                        const exampleBvz = item.例句的BVZ轉寫[i] || '';
                        const exampleAudio = item.exampleAudios[i];
                        const exampleFile = exampleAudio ? exampleAudio.filename : "";
                        const exampleURL = exampleAudio ? exampleAudio.url : "";
                        const exampleStatus = exampleAudio ? "已匹配" : "未匹配";
                        
                        const row = [
                            index + 1,
                            `"${item.詞條}"`,
                            `"${item.BVZ}"`,
                            `"${item.詞條類別}"`,
                            `"${item.釋義}"`,
                            `"${mergeStatus}"`,
                            item.exampleCount,
                            `"${vocabFile}"`,
                            `"${vocabURL}"`,
                            `"${vocabStatus}"`,
                            i + 1,
                            `"${example}"`,
                            `"${exampleBvz}"`,
                            `"${exampleFile}"`,
                            `"${exampleURL}"`,
                            `"${exampleStatus}"`
                        ].join(',');
                        csvContent += row + "\n";
                    }
                }
            });
            
            const blob = new Blob(['\ufeff' + csvContent], {
                type: 'text/csv;charset=utf-8'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vocabulary_audio_mapping_report.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('映射关系表下载成功！', 'success');
        }
        
        // 重置所有
        function resetAll() {
            excelData = null;
            audioFiles = [];
            processedData = null;
            mergedCellInfo = null;
            columnIndices = null;
            mappingInfo = {
                totalEntries: 0,
                vocabularyMatched: 0,
                vocabularyUnmatched: 0,
                exampleMatched: 0,
                examplePartialMatched: 0,
                exampleUnmatched: 0,
                totalExamples: 0,
                matchedExamples: 0,
                mergedCellsProcessed: 0,
                exampleGroups: 0,
                unmatchedItems: []
            };
            currentUnmatchedPage = 1;
            
            // 重置UI
            document.getElementById('excelFileInfo').innerHTML = '';
            document.getElementById('audioFileInfo').innerHTML = '';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('downloadMappingBtn').disabled = true;
            document.getElementById('mappingStats').innerHTML = '';
            document.getElementById('githubUsername').value = '';
            document.getElementById('githubRepo').value = '';
            document.getElementById('audioFolder').value = '';
            
            // 重置未匹配项显示
            document.getElementById('unmatchedList').innerHTML = '<p style="text-align: center; color: #666; padding: 40px 0;">暂无未匹配的项目，或尚未处理数据</p>';
            document.getElementById('unmatchedControls').style.display = 'none';
            document.getElementById('unmatchedCount').textContent = '0 项';
            
            // 重置未匹配标签按钮
            document.getElementById('unmatchedTabBtn').textContent = '未匹配项';
            
            // 重置标签页
            document.querySelector('[data-tab="preview"]').click();
            
            // 重置文件输入
            document.getElementById('excelInput').value = '';
            document.getElementById('audioInput').value = '';
            
            showStatus('已重置所有数据', 'info');
            updateProcessButton();
        }
        
        // 显示状态消息
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>