<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚æºªé‚åŸç™½è©±éŸ³å…¸ - æ¼¢å­—ä¸ç™½è©±å­—(BVZ)åæŸ¥</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --background-color: #f5f7fa;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --audio-color: #4a6fa5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Times New Roman', 'Iansui', serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            font-family: 'Iansui', 'Times New Roman', serif;
        }
        
        .dictionary-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .description {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-section {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            background: #f9fafc;
        }
        
        .search-mode {
            display: flex;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px 15px;
            text-align: center;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .mode-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .search-box {
            display: flex;
            margin-bottom: 15px;
        }
        
        #search-input {
            flex: 1;
            padding: 14px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px 0 0 5px;
            font-size: 1.2rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #search-input:focus {
            border-color: var(--primary-color);
        }
        
        #search-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        #search-button:hover {
            background: var(--secondary-color);
        }
        
        .search-options {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .exact-match-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .exact-match-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .search-info {
            font-size: 1.1rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-icon {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .config-section h3 {
            margin-bottom: 10px;
            color: #856404;
            font-size: 1.3rem;
        }
        
        /* éŸ³é‡æ§åˆ¶æ ·å¼ */
        .volume-control {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        
        .volume-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .volume-header h4 {
            color: #495057;
            font-size: 1rem;
            margin: 0;
        }
        
        .volume-value {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 40px;
            text-align: right;
        }
        
        .volume-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .volume-icon {
            color: var(--audio-color);
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }
        
        .volume-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #dee2e6;
            border-radius: 3px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--audio-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--audio-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .results-section {
            padding: 25px;
            min-height: 400px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .results-count {
            font-size: 1.2rem;
            color: #666;
        }
        
        .result-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .character {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
            line-height: 1.2;
            background-color: #fff9c4;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .details {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
        }
        
        .detail-item {
            margin-bottom: 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: flex-start;
        }
        
        .label {
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 8px;
            display: inline-block;
            min-width: 60px;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .bvz-value {
            font-family: 'Times New Roman', 'Iansui', serif !important;
            font-size: 1.4rem;
            font-weight: bold;
            line-height: 1.3;
        }
        
        /* ç®€æ´éŸ³é¢‘æŒ‰é’® */
        .audio-container {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin-left: 10px;
        }
        
        .audio-play-btn {
            background: white;
            color: var(--audio-color);
            border: 1px solid var(--audio-color);
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            padding: 0;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .audio-play-btn:hover {
            background: var(--audio-color);
            color: white;
        }
        
        .audio-play-btn.playing {
            background: var(--audio-color);
            color: white;
            border-color: var(--audio-color);
        }
        
        .audio-play-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #dc3545;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            font-size: 1.1rem;
            color: #666;
            border-top: 1px solid var(--border-color);
            background: #f9fafc;
        }
        
        @media (max-width: 768px) {
            .details {
                grid-template-columns: 1fr;
            }
            
            .character {
                font-size: 2.2rem;
            }
            
            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .volume-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .volume-value {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="dictionary-container">
        <header>
            <h1>é‚æºªé‚åŸç™½è©±éŸ³å…¸</h1>
            <p class="description">æ”¯æŒæ¼¢å­—å’Œç™½è©±å­—(BVZ)åæŸ¥åŠŸèƒ½ï¼Œè¼¸å…¥ç¹é«”æ¼¢å­—æˆ–ç™½è©±å­—(BVZ)æŸ¥æ‰¾å°æ‡‰çš„æ–¹è¨€è®€éŸ³å’Œæ³¨é‡‹</p>
        </header>
        
        <section class="search-section">
            <div class="search-mode">
                <button class="mode-btn active" data-mode="character">æ¼¢å­—æŸ¥BVZ</button>
                <button class="mode-btn" data-mode="bvz">BVZåæŸ¥æ¼¢å­—</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="search-input" placeholder="è«‹è¼¸å…¥è¦æŸ¥è©¢çš„æ¼¢å­—...">
                <button id="search-button">æœç´¢</button>
            </div>
            
            <div class="search-options">
                <div class="exact-match-option">
                    <input type="checkbox" id="exact-match" class="exact-match-checkbox">
                    <label for="exact-match">ç²¾ç¢ºåŒ¹é…</label>
                </div>
            </div>
            
            <p class="search-info">
                <span class="info-icon">â„¹ï¸</span>
                <span id="search-hint">è¼¸å…¥æ¼¢å­—æŸ¥è©¢å°æ‡‰çš„BVZè®€éŸ³å’Œæ³¨é‡‹(æ”¯æŒå¤šå­—æŸ¥è©¢ï¼Œç”¨ç©ºæ ¼åˆ†éš”)</span>
            </p>
            
            <div class="config-section">
                <h3>æ•¸æ“šç‹€æ…‹</h3>
                <div id="data-status">æ­£åœ¨åˆå§‹åŒ–...</div>
                
                <!-- éŸ³é‡æ§åˆ¶ -->
                <div class="volume-control">
                    <div class="volume-header">
                        <h4>éŸ³é‡æ§åˆ¶</h4>
                        <div class="volume-value" id="volume-value">70%</div>
                    </div>
                    <div class="volume-slider-container">
                        <div class="volume-icon">ğŸ”ˆ</div>
                        <input type="range" min="0" max="100" value="70" class="volume-slider" id="volume-slider">
                        <div class="volume-icon">ğŸ”Š</div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="results-section" id="results-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è¼‰å­—å…¸æ•¸æ“š...</p>
            </div>
        </section>
        
        <footer>
            <p>æ–¹è¨€å­—å…¸æ•¸æ“šç”±GitHubæä¾›æ”¯æŒ | è¨­è¨ˆï¼šSá»ng-jÄ© NgÃ ng</p>
        </footer>
    </div>

    <script>
        // é…ç½®
        const CONFIG = {
            JSON_URL: 'https://raw.githubusercontent.com/Seing-ji/DICTIONARY_of_Suixi_Vernacular_of_Yue_Chinese/main/DICTIONARY.json',
            MAX_RESULTS: 1000,
            AUDIO_CACHE: new Map(),
            // é¢„åŠ è½½ç­–ç•¥é…ç½®
            PRELOAD_IMMEDIATE: 3,  // ç«‹å³é¢„åŠ è½½å‰3ä¸ªç»“æœçš„éŸ³é¢‘
            PRELOAD_PRIORITY: 10,  // é«˜ä¼˜å…ˆçº§é¢„åŠ è½½å‰10ä¸ª
            PRELOAD_BACKGROUND: 20, // åå°é¢„åŠ è½½æ¥ä¸‹æ¥20ä¸ª
            // éŸ³é‡é…ç½®ï¼ˆé»˜è®¤70%ï¼Œé€‚åˆå¤§å¤šæ•°å‘éŸ³éŸ³é¢‘ï¼‰
            DEFAULT_VOLUME: 0.7,
            MIN_VOLUME: 0.0,
            MAX_VOLUME: 1.0
        };
        
        // å…¨å±€å˜é‡
        let dictionaryData = [];
        let currentMode = 'character';
        let exactMatch = false;
        let searchTimeout = null;
        let currentAudio = null;
        let currentPlayingButton = null;
        let currentResults = []; // å½“å‰æœç´¢ç»“æœ
        let audioPreloadController = null; // ç”¨äºå–æ¶ˆé¢„åŠ è½½
        let currentVolume = CONFIG.DEFAULT_VOLUME; // å½“å‰éŸ³é‡ï¼ˆ0.0-1.0ï¼‰
        
        // DOMå…ƒç´ 
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const resultsContainer = document.getElementById('results-container');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const searchHint = document.getElementById('search-hint');
        const dataStatus = document.getElementById('data-status');
        const exactMatchCheckbox = document.getElementById('exact-match');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeValue = document.getElementById('volume-value');
        
        // åˆå§‹åŒ–
        async function init() {
            dataStatus.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
            
            try {
                await loadDictionaryData();
                setupEventListeners();
                updateSearchHint();
                
                // è®¾ç½®åˆå§‹éŸ³é‡
                setVolume(CONFIG.DEFAULT_VOLUME);
                updateVolumeDisplay();
                
                searchInput.focus();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showError(`åŠ è¼‰æ•¸æ“šå¤±æ•—: ${error.message}`);
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            modeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                    updateSearchHint();
                    showMessage('è«‹è¼¸å…¥å…§å®¹é€²è¡ŒæŸ¥è©¢');
                    searchInput.value = '';
                    searchInput.focus();
                });
            });
            
            exactMatchCheckbox.addEventListener('change', function() {
                exactMatch = this.checked;
                updateSearchHint();
                const query = searchInput.value.trim();
                if (query) performSearch(query);
            });
            
            searchInput.addEventListener('input', function() {
                if (searchTimeout) clearTimeout(searchTimeout);
                
                const query = this.value.trim();
                if (!query) {
                    showMessage('è«‹è¼¸å…¥å…§å®¹é€²è¡ŒæŸ¥è©¢');
                    return;
                }
                
                searchTimeout = setTimeout(() => performSearch(query), 300);
            });
            
            searchButton.addEventListener('click', () => {
                const query = searchInput.value.trim();
                if (query) performSearch(query);
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = searchInput.value.trim();
                    if (query) performSearch(query);
                }
            });
            
            // éŸ³é‡æ»‘å—äº‹ä»¶
            volumeSlider.addEventListener('input', handleVolumeChange);
            volumeSlider.addEventListener('change', handleVolumeChange);
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }
        
        // å¤„ç†éŸ³é‡å˜åŒ–
        function handleVolumeChange() {
            const sliderValue = parseInt(volumeSlider.value);
            const volume = sliderValue / 100; // è½¬æ¢ä¸º0.0-1.0
            
            setVolume(volume);
            updateVolumeDisplay();
            
            // å¦‚æœå½“å‰æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾ï¼Œç«‹å³åº”ç”¨æ–°éŸ³é‡
            if (currentAudio) {
                currentAudio.volume = currentVolume;
            }
        }
        
        // è®¾ç½®éŸ³é‡
        function setVolume(volume) {
            // ç¡®ä¿éŸ³é‡åœ¨åˆç†èŒƒå›´å†…
            currentVolume = Math.max(CONFIG.MIN_VOLUME, Math.min(CONFIG.MAX_VOLUME, volume));
            
            // ä¿å­˜åˆ°localStorageï¼Œä¸‹æ¬¡æ‰“å¼€æ—¶è®°ä½è®¾ç½®
            try {
                localStorage.setItem('dictionary_volume', currentVolume.toString());
            } catch (e) {
                console.log('æ— æ³•ä¿å­˜éŸ³é‡è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨');
            }
        }
        
        // æ›´æ–°éŸ³é‡æ˜¾ç¤º
        function updateVolumeDisplay() {
            const percentage = Math.round(currentVolume * 100);
            volumeValue.textContent = `${percentage}%`;
            volumeSlider.value = percentage;
        }
        
        // ä»localStorageåŠ è½½éŸ³é‡è®¾ç½®
        function loadVolumeFromStorage() {
            try {
                const savedVolume = localStorage.getItem('dictionary_volume');
                if (savedVolume !== null) {
                    const volume = parseFloat(savedVolume);
                    if (!isNaN(volume) && volume >= 0 && volume <= 1) {
                        setVolume(volume);
                        return true;
                    }
                }
            } catch (e) {
                console.log('æ— æ³•ä»æœ¬åœ°å­˜å‚¨åŠ è½½éŸ³é‡è®¾ç½®');
            }
            return false;
        }
        
        // é”®ç›˜å¿«æ·é”®ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
        function handleKeyboardShortcuts(event) {
            // åªåœ¨æ²¡æœ‰èšç„¦åœ¨è¾“å…¥æ¡†æ—¶ç”Ÿæ•ˆ
            if (document.activeElement === searchInput) return;
            
            switch(event.key) {
                case '+':
                case '=':
                    // å¢åŠ éŸ³é‡
                    event.preventDefault();
                    adjustVolume(0.1);
                    break;
                case '-':
                case '_':
                    // é™ä½éŸ³é‡
                    event.preventDefault();
                    adjustVolume(-0.1);
                    break;
                case '0':
                    // é™éŸ³/æ¢å¤
                    event.preventDefault();
                    toggleMute();
                    break;
            }
        }
        
        // è°ƒæ•´éŸ³é‡ï¼ˆå¢é‡ï¼‰
        function adjustVolume(delta) {
            let newVolume = currentVolume + delta;
            newVolume = Math.max(CONFIG.MIN_VOLUME, Math.min(CONFIG.MAX_VOLUME, newVolume));
            
            setVolume(newVolume);
            updateVolumeDisplay();
            
            // å¦‚æœå½“å‰æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾ï¼Œç«‹å³åº”ç”¨æ–°éŸ³é‡
            if (currentAudio) {
                currentAudio.volume = currentVolume;
            }
        }
        
        // åˆ‡æ¢é™éŸ³
        function toggleMute() {
            if (currentVolume > 0) {
                // ä¿å­˜å½“å‰éŸ³é‡ç„¶åé™éŸ³
                localStorage.setItem('dictionary_last_volume', currentVolume.toString());
                setVolume(0);
            } else {
                // æ¢å¤ä¸Šæ¬¡çš„éŸ³é‡
                try {
                    const lastVolume = localStorage.getItem('dictionary_last_volume');
                    const volume = lastVolume ? parseFloat(lastVolume) : CONFIG.DEFAULT_VOLUME;
                    setVolume(volume);
                } catch (e) {
                    setVolume(CONFIG.DEFAULT_VOLUME);
                }
            }
            
            updateVolumeDisplay();
            
            // å¦‚æœå½“å‰æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾ï¼Œç«‹å³åº”ç”¨æ–°éŸ³é‡
            if (currentAudio) {
                currentAudio.volume = currentVolume;
            }
        }
        
        // æ‰§è¡Œæœç´¢
        async function performSearch(query) {
            // å–æ¶ˆä¹‹å‰çš„é¢„åŠ è½½
            if (audioPreloadController) {
                audioPreloadController.abort();
                audioPreloadController = null;
            }
            
            // æ‰§è¡Œæœç´¢
            const results = searchDictionary(query);
            currentResults = results; // ä¿å­˜å½“å‰ç»“æœ
            
            // ç«‹å³æ˜¾ç¤ºç»“æœ
            displayResults(results, query);
            
            // å¯åŠ¨æ™ºèƒ½é¢„åŠ è½½
            startSmartPreload(results);
        }
        
        // æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥
        function startSmartPreload(results) {
            if (!results.length) return;
            
            // åˆ›å»ºæ–°çš„AbortControllerç”¨äºæ§åˆ¶é¢„åŠ è½½
            audioPreloadController = new AbortController();
            const signal = audioPreloadController.signal;
            
            // é˜¶æ®µ1ï¼šç«‹å³é¢„åŠ è½½å‰3ä¸ªï¼ˆç”¨æˆ·æœ€å¯èƒ½ç‚¹å‡»çš„ï¼‰
            const immediateUrls = getAudioUrls(results, 0, CONFIG.PRELOAD_IMMEDIATE);
            preloadAudioBatch(immediateUrls, 'high', signal).then(() => {
                // é˜¶æ®µ1å®Œæˆåï¼Œå¯ç”¨å‰3ä¸ªæŒ‰é’®
                enableAudioButtons(0, CONFIG.PRELOAD_IMMEDIATE);
                
                // é˜¶æ®µ2ï¼šé¢„åŠ è½½å‰10ä¸ªï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
                const priorityUrls = getAudioUrls(results, CONFIG.PRELOAD_IMMEDIATE, CONFIG.PRELOAD_PRIORITY);
                return preloadAudioBatch(priorityUrls, 'medium', signal);
            }).then(() => {
                // é˜¶æ®µ2å®Œæˆåï¼Œå¯ç”¨æ¥ä¸‹æ¥çš„æŒ‰é’®
                enableAudioButtons(CONFIG.PRELOAD_IMMEDIATE, CONFIG.PRELOAD_PRIORITY);
                
                // é˜¶æ®µ3ï¼šåå°é¢„åŠ è½½æ¥ä¸‹æ¥çš„20ä¸ªï¼ˆä½ä¼˜å…ˆçº§ï¼‰
                const backgroundUrls = getAudioUrls(results, CONFIG.PRELOAD_PRIORITY, CONFIG.PRELOAD_PRIORITY + CONFIG.PRELOAD_BACKGROUND);
                return preloadAudioBatch(backgroundUrls, 'low', signal);
            }).then(() => {
                // é˜¶æ®µ3å®Œæˆåï¼Œå¯ç”¨æ‰€æœ‰æŒ‰é’®
                enableAudioButtons(CONFIG.PRELOAD_PRIORITY, results.length);
            }).catch(err => {
                if (err.name !== 'AbortError') {
                    console.warn('é¢„åŠ è½½éƒ¨åˆ†å¤±è´¥:', err);
                }
            });
        }
        
        // è·å–éŸ³é¢‘URLåˆ—è¡¨
        function getAudioUrls(results, start, end) {
            const urls = [];
            const limit = Math.min(end, results.length);
            
            for (let i = start; i < limit; i++) {
                const item = results[i];
                if (item.audioUrl && !CONFIG.AUDIO_CACHE.has(item.audioUrl)) {
                    urls.push(item.audioUrl);
                }
            }
            return urls;
        }
        
        // æ‰¹é‡é¢„åŠ è½½éŸ³é¢‘
        async function preloadAudioBatch(urls, priority = 'medium', signal) {
            if (!urls.length) return;
            
            console.log(`å¼€å§‹${priority}ä¼˜å…ˆçº§é¢„åŠ è½½ ${urls.length} ä¸ªéŸ³é¢‘`);
            
            // æ ¹æ®ä¼˜å…ˆçº§è°ƒæ•´å¹¶å‘æ•°
            let concurrency = 1;
            if (priority === 'high') concurrency = 3;
            else if (priority === 'medium') concurrency = 2;
            else concurrency = 1;
            
            // åˆ†æ‰¹é¢„åŠ è½½
            for (let i = 0; i < urls.length; i += concurrency) {
                if (signal.aborted) break;
                
                const batch = urls.slice(i, i + concurrency);
                const promises = batch.map(url => preloadSingleAudio(url, signal));
                
                await Promise.all(promises);
                
                // æ‰¹æ¬¡é—´å»¶è¿Ÿï¼Œé¿å…é˜»å¡
                if (i + concurrency < urls.length && !signal.aborted) {
                    await new Promise(resolve => setTimeout(resolve, priority === 'high' ? 0 : 50));
                }
            }
        }
        
        // é¢„åŠ è½½å•ä¸ªéŸ³é¢‘
        async function preloadSingleAudio(audioUrl, signal) {
            // æ£€æŸ¥æ˜¯å¦å·²åœ¨ç¼“å­˜ä¸­
            if (CONFIG.AUDIO_CACHE.has(audioUrl)) {
                return CONFIG.AUDIO_CACHE.get(audioUrl);
            }
            
            try {
                // ä½¿ç”¨AbortSignalå…è®¸å–æ¶ˆ
                const response = await fetch(audioUrl, { signal });
                if (!response.ok) return null;
                
                const blob = await response.blob();
                
                // ä¿®å¤MIMEç±»å‹
                let audioBlob = blob;
                if (!blob.type.startsWith('audio/')) {
                    audioBlob = new Blob([blob], { type: 'audio/mpeg' });
                }
                
                const blobUrl = URL.createObjectURL(audioBlob);
                CONFIG.AUDIO_CACHE.set(audioUrl, blobUrl);
                return blobUrl;
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.warn('éŸ³é¢‘é¢„åŠ è½½å¤±è´¥:', audioUrl, error);
                }
                return null;
            }
        }
        
        // å¯ç”¨éŸ³é¢‘æŒ‰é’®
        function enableAudioButtons(start, end) {
            const buttons = resultsContainer.querySelectorAll('.audio-play-btn');
            const limit = Math.min(end, buttons.length);
            
            for (let i = start; i < limit; i++) {
                const button = buttons[i];
                if (button.disabled) {
                    const audioUrl = decodeURIComponent(button.getAttribute('data-audio-url'));
                    if (CONFIG.AUDIO_CACHE.has(audioUrl)) {
                        button.disabled = false;
                        button.title = 'é»æ“Šæ’­æ”¾ç™¼éŸ³';
                    }
                }
            }
        }
        
        // åŠ è½½å­—å…¸æ•°æ®
        async function loadDictionaryData() {
            showLoading();
            dataStatus.textContent = 'æ­£åœ¨å¾GitHubåŠ è¼‰æ•¸æ“š...';
            
            try {
                const response = await fetch(CONFIG.JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTPéŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
                }
                
                const text = await response.text();
                const data = JSON.parse(text);
                dictionaryData = processData(data);
                
                const itemsWithAudio = dictionaryData.filter(item => item.audioUrl).length;
                dataStatus.textContent = `æ•¸æ“šåŠ è¼‰æˆåŠŸ! å…± ${dictionaryData.length} æ¢è¨˜éŒ„`;
                if (itemsWithAudio > 0) {
                    dataStatus.textContent += ` | ${itemsWithAudio} æ¢è¨˜éŒ„åŒ…å«éŸ³é »`;
                }
                
                showMessage('æ•¸æ“šåŠ è¼‰æˆåŠŸ! è«‹è¼¸å…¥å…§å®¹é€²è¡ŒæŸ¥è©¢');
                
            } catch (error) {
                console.error('åŠ è¼‰æ•¸æ“šå¤±æ•—:', error);
                dataStatus.textContent = `æ•¸æ“šåŠ è¼‰å¤±æ•—: ${error.message}`;
                throw error;
            }
        }
        
        // å¤„ç†æ•°æ®æ ¼å¼
        function processData(data) {
            if (!data || typeof data !== 'object') {
                throw new Error('æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
            }
            
            let dataArray = Array.isArray(data) ? data : Object.values(data);
            
            return dataArray
                .filter(item => item && (item.å–®å­— || item.BVZ))
                .map(item => {
                    // ä¿®å¤éŸ³é¢‘URL - ä½¿ç”¨jsDelivr CDNç¡®ä¿å¯æ’­æ”¾
                    let audioUrl = item.audio || '';
                    if (audioUrl && audioUrl.includes('github.com')) {
                        // è½¬æ¢ä¸ºjsDelivr CDN URL
                        audioUrl = audioUrl
                            .replace('https://raw.githubusercontent.com/', 'https://cdn.jsdelivr.net/gh/')
                            .replace('/main/', '/');
                    }
                    
                    return {
                        å–®å­—: item.å–®å­— || '',
                        BVZ: item.BVZ || '',
                        Note: item.Note || item.note || '',
                        audioUrl: audioUrl
                    };
                });
        }
        
        // æ›´æ–°æœç´¢æç¤º
        function updateSearchHint() {
            if (currentMode === 'character') {
                searchInput.placeholder = 'è«‹è¼¸å…¥è¦æŸ¥è©¢çš„æ¼¢å­—(å¤šå­—ç”¨ç©ºæ ¼åˆ†éš”)...';
                if (exactMatch) {
                    searchHint.textContent = 'è¼¸å…¥æ¼¢å­—æŸ¥è©¢å°æ‡‰çš„ç™½è©±å­—(BVZ)å’Œæ³¨é‡‹(ç²¾ç¢ºåŒ¹é…æ¨¡å¼)';
                } else {
                    searchHint.textContent = 'è¼¸å…¥æ¼¢å­—æŸ¥è©¢å°æ‡‰çš„ç™½è©±å­—(BVZ)å’Œæ³¨é‡‹(æ”¯æŒå¤šå­—æŸ¥è©¢, ç”¨ç©ºæ ¼åˆ†éš”)';
                }
            } else {
                searchInput.placeholder = 'è«‹è¼¸å…¥ç™½è©±å­—(BVZ)(å¤šå€‹ç”¨ç©ºæ ¼åˆ†éš”)...';
                if (exactMatch) {
                    searchHint.textContent = 'è¼¸å…¥ç™½è©±å­—(BVZ)åæŸ¥å°æ‡‰çš„æ¼¢å­—å’Œæ³¨é‡‹(ç²¾ç¢ºåŒ¹é…æ¨¡å¼)';
                } else {
                    searchHint.textContent = 'è¼¸å…¥ç™½è©±å­—(BVZ)åæŸ¥å°æ‡‰çš„æ¼¢å­—å’Œæ³¨é‡‹(æ”¯æŒå¤šå€‹BVZæŸ¥è©¢, ç”¨ç©ºæ ¼åˆ†éš”)';
                }
            }
        }
        
        // æœç´¢å­—å…¸æ•°æ®
        function searchDictionary(query) {
            if (!dictionaryData.length) return [];
            
            const searchTerms = query.split(/\s+/).filter(term => term.length > 0);
            const results = [];
            
            if (currentMode === 'character') {
                // æ±‰å­—æŸ¥BVZæ¨¡å¼
                if (exactMatch) {
                    // ç²¾ç¡®åŒ¹é…ï¼šæ±‰å­—å®Œå…¨ç›¸ç­‰
                    const termSet = new Set(searchTerms);
                    for (let i = 0; i < dictionaryData.length; i++) {
                        const item = dictionaryData[i];
                        if (item.å–®å­— && termSet.has(item.å–®å­—)) {
                            results.push(item);
                        }
                    }
                } else {
                    // æ¨¡ç³ŠåŒ¹é…ï¼šæ±‰å­—åŒ…å«æœç´¢è¯
                    for (let i = 0; i < dictionaryData.length; i++) {
                        const item = dictionaryData[i];
                        if (item.å–®å­—) {
                            for (let j = 0; j < searchTerms.length; j++) {
                                if (item.å–®å­—.includes(searchTerms[j])) {
                                    results.push(item);
                                    break;
                                }
                            }
                        }
                    }
                }
            } else {
                // BVZåæŸ¥æ±‰å­—æ¨¡å¼
                if (exactMatch) {
                    // ç²¾ç¡®åŒ¹é…ï¼šBVZå®Œå…¨ç›¸ç­‰
                    const termSet = new Set(searchTerms);
                    for (let i = 0; i < dictionaryData.length; i++) {
                        const item = dictionaryData[i];
                        if (item.BVZ && termSet.has(item.BVZ)) {
                            results.push(item);
                        }
                    }
                } else {
                    // æ¨¡ç³ŠåŒ¹é…ï¼šBVZåŒ…å«æœç´¢è¯
                    for (let i = 0; i < dictionaryData.length; i++) {
                        const item = dictionaryData[i];
                        if (item.BVZ) {
                            for (let j = 0; j < searchTerms.length; j++) {
                                if (item.BVZ.includes(searchTerms[j])) {
                                    results.push(item);
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            
            return results.slice(0, CONFIG.MAX_RESULTS);
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displayResults(results, query) {
            if (!results.length) {
                showMessage(`æ²’æœ‰æ‰¾åˆ°èˆ‡"${query}"ç›¸é—œçš„çµæœ`);
                return;
            }
            
            let html = `
                <div class="results-header">
                    <h2>æœç´¢çµæœ</h2>
                    <div class="results-count">æ‰¾åˆ° ${results.length} æ¢çµæœ ${exactMatch ? '(ç²¾ç¢ºåŒ¹é…)' : ''}</div>
                </div>
            `;
            
            results.forEach((item, index) => {
                const hasAudio = item.audioUrl && item.audioUrl.length > 0;
                const audioId = `audio-${Date.now()}-${index}`;
                const isPreloaded = hasAudio && CONFIG.AUDIO_CACHE.has(item.audioUrl);
                
                // å‰3ä¸ªç»“æœé»˜è®¤å¯ç”¨ï¼ˆä¼šç«‹å³é¢„åŠ è½½ï¼‰
                const isTopResult = index < CONFIG.PRELOAD_IMMEDIATE;
                
                html += `
                    <div class="result-item" data-index="${index}">
                        <div class="character">${item.å–®å­—}</div>
                        <div class="details">
                            <div class="detail-item">
                                <span class="label">BVZ:</span> 
                                <span class="bvz-value">${item.BVZ}</span>
                                ${hasAudio ? `
                                <div class="audio-container">
                                    <button class="audio-play-btn" 
                                            data-audio-id="${audioId}" 
                                            data-audio-url="${encodeURIComponent(item.audioUrl)}"
                                            title="é»æ“Šæ’­æ”¾ç™¼éŸ³"
                                            ${isPreloaded || isTopResult ? '' : 'disabled'}>
                                        â–¶
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                            ${item.Note ? `
                            <div class="detail-item">
                                <span class="label">æ³¨é‡‹:</span> 
                                <span>${item.Note}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            
            // æ·»åŠ éŸ³é¢‘æŒ‰é’®äº‹ä»¶
            const audioButtons = resultsContainer.querySelectorAll('.audio-play-btn');
            audioButtons.forEach(button => {
                button.addEventListener('click', handleAudioPlay);
            });
        }
        
        // å¤„ç†éŸ³é¢‘æ’­æ”¾
        async function handleAudioPlay(event) {
            const button = event.currentTarget;
            const audioUrl = decodeURIComponent(button.getAttribute('data-audio-url'));
            
            if (!audioUrl) return;
            
            // å¦‚æœå·²ç»åœ¨æ’­æ”¾ï¼Œåœæ­¢å®ƒ
            if (currentAudio && currentPlayingButton === button) {
                stopCurrentAudio();
                return;
            }
            
            // åœæ­¢å½“å‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
            if (currentAudio) {
                stopCurrentAudio();
            }
            
            // æ£€æŸ¥ç¼“å­˜
            let audioBlobUrl = CONFIG.AUDIO_CACHE.get(audioUrl);
            
            if (!audioBlobUrl) {
                // å¦‚æœä¸åœ¨ç¼“å­˜ï¼Œç«‹å³ä¸‹è½½ï¼ˆè¿™ç§æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼‰
                console.log('éŸ³é¢‘ä¸åœ¨ç¼“å­˜ï¼Œç«‹å³ä¸‹è½½:', audioUrl);
                try {
                    const response = await fetch(audioUrl);
                    const blob = await response.blob();
                    audioBlobUrl = URL.createObjectURL(new Blob([blob], { type: 'audio/mpeg' }));
                    CONFIG.AUDIO_CACHE.set(audioUrl, audioBlobUrl);
                } catch (error) {
                    console.error('éŸ³é¢‘ä¸‹è½½å¤±è´¥:', error);
                    return;
                }
            }
            
            // æ’­æ”¾éŸ³é¢‘ï¼ˆåº”ç”¨å½“å‰éŸ³é‡ï¼‰
            playAudio(audioBlobUrl, button);
        }
        
        // æ’­æ”¾éŸ³é¢‘
        function playAudio(audioUrl, button) {
            currentAudio = new Audio(audioUrl);
            currentPlayingButton = button;
            
            // åº”ç”¨å½“å‰éŸ³é‡è®¾ç½®
            currentAudio.volume = currentVolume;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            button.textContent = 'â¸';
            button.classList.add('playing');
            button.title = 'é»æ“Šæš«åœ';
            
            // éŸ³é¢‘äº‹ä»¶å¤„ç†
            currentAudio.addEventListener('error', (e) => {
                console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', currentAudio.error);
                resetAudioButton(button);
                currentAudio = null;
                currentPlayingButton = null;
            });
            
            currentAudio.addEventListener('ended', () => {
                resetAudioButton(button);
                currentAudio = null;
                currentPlayingButton = null;
            });
            
            // å¼€å§‹æ’­æ”¾
            currentAudio.play().catch(error => {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                resetAudioButton(button);
                currentAudio = null;
                currentPlayingButton = null;
            });
        }
        
        // åœæ­¢å½“å‰éŸ³é¢‘
        function stopCurrentAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                
                if (currentPlayingButton) {
                    resetAudioButton(currentPlayingButton);
                }
                
                currentAudio = null;
                currentPlayingButton = null;
            }
        }
        
        // é‡ç½®éŸ³é¢‘æŒ‰é’®çŠ¶æ€
        function resetAudioButton(button) {
            button.textContent = 'â–¶';
            button.classList.remove('playing');
            button.title = 'æ’­æ”¾ç™¼éŸ³';
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            resultsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è¼‰å­—å…¸æ•¸æ“š...</p>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message) {
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">ğŸ”</div>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            resultsContainer.innerHTML = `
                <div class="error-message">
                    <strong>éŒ¯èª¤:</strong> ${message}
                </div>
            `;
        }
        
        // æ¸…ç†Blob URL
        window.addEventListener('beforeunload', () => {
            CONFIG.AUDIO_CACHE.forEach(blobUrl => {
                URL.revokeObjectURL(blobUrl);
            });
            CONFIG.AUDIO_CACHE.clear();
            
            if (audioPreloadController) {
                audioPreloadController.abort();
            }
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>